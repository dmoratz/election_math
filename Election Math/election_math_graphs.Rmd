---
title: "election_math_graphs"
author: "Donald Moratz"
date: "2025-07-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list = ls())
library(pacman)
p_load(foreign, haven, ggplot2, broom, DataCombine, plm, estimatr, gsynth, reshape2, zoo, stargazer, here, modelsummary, interflex, sandwich, multcomp, lmtest, kableExtra, texreg, fastDummies, ggdag, AER ,stats, tidyr, cowplot, stringr, knitr, scales, dplyr, viridis)

options(scipen = 999)

set.seed(3184)

election_analysis_data <- readRDS("election_analysis.rds")
derivative_grimmer <- election_analysis_data$derivative_grimmer_data
derivative_simple_sim <- election_analysis_data$derivative_simple_sim
derivative_rate_only <- election_analysis_data$derivative_rate_only
derivative_mix_only <- election_analysis_data$derivative_mix_only
derivative_rate_mix <- election_analysis_data$derivative_rate_mix
rcv_grimmer <- election_analysis_data$rcv_grimmer_data
rcv_pew_16v20 <- election_analysis_data$rcv_pew_data_16v20
rcv_pew_20v24 <- election_analysis_data$rcv_pew_data_20v24
rcv_pew_16v24 <- election_analysis_data$rcv_pew_data_16v24
derivative_pew <- election_analysis_data$derivative_pew_data
rcv_simple_sim <- election_analysis_data$rcv_simple_sim
rcv_rate_only <- election_analysis_data$rcv_rate_only
rcv_mix_only <- election_analysis_data$rcv_mix_only
rcv_rate_mix <- election_analysis_data$rcv_rate_mix

# Vote totals
vote_dem_2016 <- 65853514
vote_rep_2016 <- 62984828
vote_total_2016 <- vote_dem_2016 + vote_rep_2016
vote_margin_2016 <- vote_dem_2016-vote_rep_2016
vote_dem_2020 <- 81283501
vote_rep_2020 <- 74223975
vote_total_2020 <- vote_dem_2020 + vote_rep_2020
vote_margin_2020 <- vote_dem_2020-vote_rep_2020
vote_margin_diff_1620 <- vote_margin_2020 - vote_margin_2016
vote_dem_2024 <- 75017613
vote_rep_2024 <- 77302580
vote_total_2024 <- vote_dem_2024 + vote_rep_2024
vote_margin_2024 <- vote_dem_2024-vote_rep_2024
vote_margin_diff_2024 <- vote_margin_2024 - vote_margin_2020
vote_margin_diff_1624 <- vote_margin_2024 - vote_margin_2016

```

```{r}
# create colors for consistent usage
colors = viridis(6, option = "turbo")
```

# Simple Simulation

```{r}
# Create the data
# data from real data grimmer tab
data <- data.frame(
  Demographic = c("Non-White", "Non-White",
                  "White", "White"),
  Calculation_Method = c("RCVD", "Traditional",
                         "RCVD", "Traditional"),
  Value = c(rcv_simple_sim$Mix[1], derivative_simple_sim$Mix[1],
            rcv_simple_sim$Mix[2], derivative_simple_sim$Mix[2])
)

# Ensure Demographic is a factor with the desired order
data$Demographic <- factor(data$Demographic,
                           levels = c("Non-White", "White"))
```

```{r}
# 2. Create the grouped bar chart using ggplot2
ggplot(data, aes(x = Demographic, y = Value, fill = Calculation_Method)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.7) +
  scale_fill_manual(values = c("RCVD" = colors[1], "Traditional" = colors[6])) + # Custom colors
  labs(
    title = "Impact of Mix on Simulated 2020 Election",
    subtitle = "Comparing RCVD vs Traditional Calculation",
    x = "", 
    y = "Total Votes"
  ) +
  #scale_y_continuous(labels = scales::comma, # Format y-axis labels with commas
  #                   breaks = seq(-400000, 1000000, by = 200000), # Set specific breaks
  #                   limits = c(-400000, 1000000)) + # Set y-axis limits
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"), # Center and style main title
    plot.subtitle = element_text(hjust = 0.5, size = 14), # Center and style subtitle
    axis.text.x = element_text(size = 12), # Adjust x-axis text size
    axis.text.y = element_text(size = 12), # Adjust y-axis text size
    legend.position = "bottom", # Position legend at the bottom
    legend.title = element_blank(), # Remove legend title
    legend.text = element_text(size = 11), # Adjust legend text size
    panel.grid.major.x = element_blank(), # Remove vertical grid lines
    panel.grid.minor.x = element_blank(), # Remove minor vertical grid lines
    panel.grid.major.y = element_line(color = "grey", linetype = "dashed"), # Style horizontal grid lines
    panel.grid.minor.y = element_blank() # Remove minor horizontal grid lines
  )

ggsave("simple_simulation_chart.png", width = 10, height = 6, dpi = 300)
```

# Reimagining the 2020 Election

### Rate and Mix

```{r}
# Use the Grimmer Data
# This data represents the components for each calculation method and a total change.
# You will need to replace these with your actual numbers.
data_components <- data.frame(
  Demographic = rep(c("Black", "Hispanic", "Other", "White", "Unknown"), each = 2),
  Calculation_Method = rep(c("Traditional", "RCVD"), times = 5),
  Rate = c(
    # Black
    derivative_rate_mix$Rate[1], rcv_rate_mix$Rate[1],
    # Hispanic
    derivative_rate_mix$Rate[2], rcv_rate_mix$Rate[2],
    # Other
    derivative_rate_mix$Rate[3], rcv_rate_mix$Rate[3],
    # White
    derivative_rate_mix$Rate[4], rcv_rate_mix$Rate[4],
    # NA
    derivative_rate_mix$Rate[5], rcv_rate_mix$Rate[5]
  ),
  Composition = c(
    # Black
    derivative_rate_mix$Mix[1], rcv_rate_mix$Mix[1],
    # Hispanic
    derivative_rate_mix$Mix[2], rcv_rate_mix$Mix[2],
    # Other
    derivative_rate_mix$Mix[3], rcv_rate_mix$Mix[3],
    # White
    derivative_rate_mix$Mix[4], rcv_rate_mix$Mix[4],
    # NA
    derivative_rate_mix$Mix[5], rcv_rate_mix$Mix[5]
  ),
  Volume = c(
    # Black
    derivative_rate_mix$Volume[1], rcv_rate_mix$Volume[1],
    # Hispanic
    derivative_rate_mix$Volume[2], rcv_rate_mix$Volume[2],
    # Other
    derivative_rate_mix$Volume[3], rcv_rate_mix$Volume[3],
    # White
    derivative_rate_mix$Volume[4], rcv_rate_mix$Volume[4],
    # NA
    derivative_rate_mix$Volume[5], rcv_rate_mix$Volume[5]
  ),
  Residual = c(
    # Black (Traditional has residual, RCV has 0)
    derivative_rate_mix$Var_to_Act[1], rcv_rate_mix$Var_to_Act[1],
    # Hispanic
    derivative_rate_mix$Var_to_Act[2], rcv_rate_mix$Var_to_Act[2],
    # Other
    derivative_rate_mix$Var_to_Act[3], rcv_rate_mix$Var_to_Act[3],
    # White
    derivative_rate_mix$Var_to_Act[4], rcv_rate_mix$Var_to_Act[4],
    # NA
    derivative_rate_mix$Var_to_Act[5], rcv_rate_mix$Var_to_Act[5]
  )
)

# Calculate the 'Total Change' for Traditional and RCV based on components
data_components <- data_components %>%
  rowwise() %>%
  mutate(Calculated_Total = sum(Rate, Composition, Volume, Residual)) %>%
  ungroup()

# Calculate total components across all demographics for Traditional and RCV
total_components <- data_components %>%
  group_by(Calculation_Method) %>%
  summarise(
    Rate = sum(Rate),
    Composition = sum(Composition),
    Volume = sum(Volume),
    Residual = sum(Residual)
  ) %>%
  mutate(Demographic = "Total") %>%
  ungroup()

# Bind this to the original data_components
data_components_with_total <- bind_rows(data_components, total_components)

# Reshape the components data for stacking
data_long <- data_components_with_total %>% # Use the combined data
  pivot_longer(
    cols = c(Rate, Composition, Volume, Residual),
    names_to = "Component",
    values_to = "Value"
  ) %>%
  # Add a 'Type' column to distinguish between 'Component'
  mutate(Type = "Component")

# Combine the data - only using the 'data_long' for components
final_data <- data_long %>%
  # Order the Calculation_Method for plotting
  mutate(Calculation_Method = factor(Calculation_Method,
                                     levels = c("Traditional", "RCVD"))) %>%
  # Order the Component for stacking (bottom to top)
  mutate(Component = factor(Component,
                            levels = c("Residual", "Volume", "Composition", "Rate"))) %>%
  # Order the Demographic groups, including "Total" at the end
  mutate(Demographic = factor(Demographic,
                              levels = c("Black", "Hispanic", "Other", "White", "Unknown", "Total")))
```

```{r}
# 2. Create the stacked bar chart using ggplot2
ggplot(final_data, aes(x = Calculation_Method, y = Value, fill = Component)) +
  geom_bar(stat = "identity", position = "stack", width = 0.7) +
  facet_wrap(~ Demographic, scales = "free_y", nrow = 2) + # Facet into 2 rows
  scale_fill_manual(
    values = c(
      "Rate" = colors[2],       # blue
      "Composition" = colors[3], # green
      "Volume" = colors[4],    # orange
      "Residual" = colors[5]    # Pinkish
    ),
    breaks = c("Rate", "Composition", "Volume", "Residual") # Ensure order in legend
  ) +
  labs(
    title = "2020 vs 2020 Hypothetical Vote Change Decomposition",
    subtitle = "Comparing Traditional vs RCVD Components",
    x = "", # X-axis label handled by facets and subheaders
    y = "Vote Change for Democratic Candidate"
  ) +
  scale_y_continuous(labels = scales::comma) + # Format y-axis labels with commas
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10), # Rotated 45 degrees, right-justified
    axis.text.y = element_text(size = 10),
    axis.title.y = element_text(size = 12, margin = margin(r = 10)), # Add margin to y-axis title
    legend.position = "right",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 10),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey", linetype = "dashed"),
    panel.grid.minor.y = element_blank(),
    strip.text = element_text(size = 12, face = "bold", margin = margin(b = 10, unit = "pt"))#, # Added bottom margin to facet labels
    #plot.margin = unit(c(2, 1, 1, 1), "cm") # Increased top plot margin to 2cm
  )

# To save the plot (optional)
ggsave("rate_mix_chart.png", width = 12, height = 7, dpi = 300)
```




# Impact of Mix

```{r}
# Create the data
# data from real data grimmer tab
data <- data.frame(
  Demographic = c("Black", "Black",
                  "Hispanic", "Hispanic",
                  "Other", "Other",
                  "White", "White",
                  "Unknown", "Unknown"),
  Calculation_Method = c("RCVD", "Traditional",
                         "RCVD", "Traditional",
                         "RCVD", "Traditional",
                         "RCVD", "Traditional",
                         "RCVD", "Traditional"),
  Value = c(rcv_grimmer$Mix[1], derivative_grimmer$Mix[1],    # Black
            rcv_grimmer$Mix[2], derivative_grimmer$Mix[2],    # Hispanic
            rcv_grimmer$Mix[3], derivative_grimmer$Mix[3],    # Other
            rcv_grimmer$Mix[4], derivative_grimmer$Mix[4],    # White
            rcv_grimmer$Mix[5], derivative_grimmer$Mix[5])     # NA
)

# Ensure Demographic is a factor with the desired order
data$Demographic <- factor(data$Demographic,
                           levels = c("Black", "Hispanic", "Other", "White", "Unknown"))
```

```{r}
# 2. Create the grouped bar chart using ggplot2
ggplot(data, aes(x = Demographic, y = Value, fill = Calculation_Method)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.7) +
  scale_fill_manual(values = c("RCVD" = colors[1], "Traditional" = colors[6])) + # Custom colors
  labs(
    title = "Impact of Mix on 2020 Election",
    subtitle = "Comparing RCV vs Traditional Calculation",
    x = "", 
    y = "Total Votes"
  ) +
  scale_y_continuous(labels = scales::comma, # Format y-axis labels with commas
                     breaks = seq(-400000, 1000000, by = 200000), # Set specific breaks
                     limits = c(-400000, 1000000)) + # Set y-axis limits
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"), # Center and style main title
    plot.subtitle = element_text(hjust = 0.5, size = 14), # Center and style subtitle
    axis.text.x = element_text(size = 12), # Adjust x-axis text size
    axis.text.y = element_text(size = 12), # Adjust y-axis text size
    legend.position = "bottom", # Position legend at the bottom
    legend.title = element_blank(), # Remove legend title
    legend.text = element_text(size = 11), # Adjust legend text size
    panel.grid.major.x = element_blank(), # Remove vertical grid lines
    panel.grid.minor.x = element_blank(), # Remove minor vertical grid lines
    panel.grid.major.y = element_line(color = "grey", linetype = "dashed"), # Style horizontal grid lines
    panel.grid.minor.y = element_blank() # Remove minor horizontal grid lines
  )

ggsave("election_impact_chart.png", width = 10, height = 6, dpi = 300)
```

# Tracking the Residual

```{r}
# Use the Grimmer Data
# This data represents the components for each calculation method and a total change.
# You will need to replace these with your actual numbers.
data_components <- data.frame(
  Demographic = rep(c("Black", "Hispanic", "Other", "White", "Unknown"), each = 2),
  Calculation_Method = rep(c("Traditional", "RCVD"), times = 5),
  Rate = c(
    # Black
    derivative_grimmer$Rate[1], rcv_grimmer$Rate[1],
    # Hispanic
    derivative_grimmer$Rate[2], rcv_grimmer$Rate[2],
    # Other
    derivative_grimmer$Rate[3], rcv_grimmer$Rate[3],
    # White
    derivative_grimmer$Rate[4], rcv_grimmer$Rate[4],
    # NA
    derivative_grimmer$Rate[5], rcv_grimmer$Rate[5]
  ),
  Composition = c(
    # Black
    derivative_grimmer$Mix[1], rcv_grimmer$Mix[1],
    # Hispanic
    derivative_grimmer$Mix[2], rcv_grimmer$Mix[2],
    # Other
    derivative_grimmer$Mix[3], rcv_grimmer$Mix[3],
    # White
    derivative_grimmer$Mix[4], rcv_grimmer$Mix[4],
    # NA
    derivative_grimmer$Mix[5], rcv_grimmer$Mix[5]
  ),
  Volume = c(
    # Black
    derivative_grimmer$Volume[1], rcv_grimmer$Volume[1],
    # Hispanic
    derivative_grimmer$Volume[2], rcv_grimmer$Volume[2],
    # Other
    derivative_grimmer$Volume[3], rcv_grimmer$Volume[3],
    # White
    derivative_grimmer$Volume[4], rcv_grimmer$Volume[4],
    # NA
    derivative_grimmer$Volume[5], rcv_grimmer$Volume[5]
  ),
  Residual = c(
    # Black (Traditional has residual, RCV has 0)
    derivative_grimmer$Var_to_Act[1], rcv_grimmer$Var_to_Act[1],
    # Hispanic
    derivative_grimmer$Var_to_Act[2], rcv_grimmer$Var_to_Act[2],
    # Other
    derivative_grimmer$Var_to_Act[3], rcv_grimmer$Var_to_Act[3],
    # White
    derivative_grimmer$Var_to_Act[4], rcv_grimmer$Var_to_Act[4],
    # NA
    derivative_grimmer$Var_to_Act[5], rcv_grimmer$Var_to_Act[5]
  )
)

# Calculate the 'Total Change' for Traditional and RCV based on components
data_components <- data_components %>%
  rowwise() %>%
  mutate(Calculated_Total = sum(Rate, Composition, Volume, Residual)) %>%
  ungroup()

# Calculate total components across all demographics for Traditional and RCV
total_components <- data_components %>%
  group_by(Calculation_Method) %>%
  summarise(
    Rate = sum(Rate),
    Composition = sum(Composition),
    Volume = sum(Volume),
    Residual = sum(Residual)
  ) %>%
  mutate(Demographic = "Total") %>%
  ungroup()

# Bind this to the original data_components
data_components_with_total <- bind_rows(data_components, total_components)

# Reshape the components data for stacking
data_long <- data_components_with_total %>% # Use the combined data
  pivot_longer(
    cols = c(Rate, Composition, Volume, Residual),
    names_to = "Component",
    values_to = "Value"
  ) %>%
  # Add a 'Type' column to distinguish between 'Component'
  mutate(Type = "Component")

# Combine the data - only using the 'data_long' for components
final_data <- data_long %>%
  # Order the Calculation_Method for plotting
  mutate(Calculation_Method = factor(Calculation_Method,
                                     levels = c("Traditional", "RCVD"))) %>%
  # Order the Component for stacking (bottom to top)
  mutate(Component = factor(Component,
                            levels = c("Residual", "Volume", "Composition", "Rate"))) %>%
  # Order the Demographic groups, including "Total" at the end
  mutate(Demographic = factor(Demographic,
                              levels = c("Black", "Hispanic", "Other", "White", "Unknown", "Total")))
```

```{r}
# 2. Create the stacked bar chart using ggplot2
ggplot(final_data, aes(x = Calculation_Method, y = Value, fill = Component)) +
  geom_bar(stat = "identity", position = "stack", width = 0.7) +
  facet_wrap(~ Demographic, scales = "free_y", nrow = 2) + # Facet into 2 rows
  scale_fill_manual(
    values = c(
      "Rate" = colors[2],       # blue
      "Composition" = colors[3], # green
      "Volume" = colors[4],    # orange
      "Residual" = colors[5]    # Pinkish
    ),
    breaks = c("Rate", "Composition", "Volume", "Residual") # Ensure order in legend
  ) +
  labs(
    title = "2016 to 2020 Vote Change Decomposition",
    subtitle = "Comparing Traditional vs RCVD Components",
    x = "", # X-axis label handled by facets and subheaders
    y = "Vote Change for Democratic Candidate"
  ) +
  scale_y_continuous(labels = scales::comma) + # Format y-axis labels with commas
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10), # Rotated 45 degrees, right-justified
    axis.text.y = element_text(size = 10),
    axis.title.y = element_text(size = 12, margin = margin(r = 10)), # Add margin to y-axis title
    legend.position = "right",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 10),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey", linetype = "dashed"),
    panel.grid.minor.y = element_blank(),
    strip.text = element_text(size = 12, face = "bold", margin = margin(b = 10, unit = "pt"))#, # Added bottom margin to facet labels
    #plot.margin = unit(c(2, 1, 1, 1), "cm") # Increased top plot margin to 2cm
  )

# To save the plot (optional)
ggsave("stacked_bar_chart_decomposition.png", width = 12, height = 7, dpi = 300)
```

# Analysis of Pew Data

```{r}
# Create the data
# data from real data grimmer tab and real pew tab
data_hispanic <- data.frame(
  Component = c("Rate", "Rate",
                "Composition", "Composition",
                "Volume", "Volume",
                "Residual", "Residual"),
  Data_Source = c("ANES", "PEW",
                         "ANES", "PEW",
                         "ANES", "PEW",
                         "ANES", "PEW"),
  Value = c(rcv_grimmer$Rate[2], rcv_pew_16v20$Rate[3],    # Rate
            rcv_grimmer$Mix[2], rcv_pew_16v20$Mix[3],    # Composition
            rcv_grimmer$Volume[2], rcv_pew_16v20$Volume[3],    # Volume
            (sum(rcv_grimmer$Calc_Mar_Chng)-vote_margin_diff_1620), (sum(rcv_pew_16v20$Calc_Mar_Chng)-vote_margin_diff_1620))     # Residual
)

# Ensure Demographic is a factor with the desired order
data_hispanic$Component <- factor(data_hispanic$Component,
                           levels = c("Rate", "Composition", "Volume", "Residual"))
```

```{r}
# Create the grouped bar chart using ggplot2
# Filter out Residual for the main plot
main_plot_data <- data_hispanic %>%
  filter(Component != "Residual")

p_main <- ggplot(main_plot_data, aes(x = Component, y = Value, fill = Data_Source)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.7) + # Changed to grouped bars
  scale_fill_manual(values = c("ANES" = colors[1], "PEW" = colors[6])) + # Custom colors
  labs(
    title = "Shifting Interpretations of 2016 vs 2020",
    subtitle = "Comparing Pew vs ANES Data for Hispanic Voters",
    x = "", # Component will be the x-axis labels
    y = "Total Votes"
  ) +
  scale_y_continuous(labels = scales::comma,
                     breaks = seq(-2000000, 2000000, by = 500000), # Adjusted breaks for new data range
                     limits = c(-2000000, 2000000)) + # Adjusted limits for new data range
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 14),
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 12), # No rotation, centered
    axis.text.y = element_text(size = 12),
    axis.title.y = element_text(size = 12, margin = margin(r = 10)),
    legend.position = "right", # Position legend at the right
    legend.title = element_blank(), # Remove legend title
    legend.text = element_text(size = 11), # Adjust legend text size
    panel.grid.major.x = element_blank(), # Remove vertical grid lines
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey", linetype = "dashed"),
    panel.grid.minor.y = element_blank()#,
    #plot.margin = unit(c(1, 1, 0.5, 1), "cm") # Adjusted bottom margin for space for second plot
  )

# 3. Create data for the residual bar chart
residual_data <- data_hispanic %>%
  filter(Component == "Residual")

# 4. Create the horizontal residual bar chart (p_residual)
p_residual <- ggplot(residual_data, aes(x = Data_Source, y = Value, fill = Data_Source)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7)) +
  coord_flip() + # Make bars horizontal
  scale_fill_manual(values = c("ANES" = colors[1], "PEW" = colors[6])) + # Use main plot colors for consistency
  labs(
    title = "Total Source Residuals vs True Results", # Title for the residual chart
    subtitle = "",
    x = "", # No x-axis label
    y = "Residual Value" # Y-axis label for residual
  ) +
  scale_y_continuous(labels = scales::comma) + # Format y-axis labels
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"), # Title for sub-plot
    plot.subtitle = element_blank(),
    axis.text.x = element_text(size = 10), # Adjust text size for horizontal axis
    axis.text.y = element_text(size = 10), # Adjust text size for vertical axis (Data_Source)
    axis.title.x = element_text(size = 12, margin = margin(t = 10)), # Add top margin to x-axis title
    axis.title.y = element_blank(), # Remove y-axis title as it's redundant with coord_flip and specific context
    legend.position = "none", # No legend for this plot
    panel.grid.major.x = element_line(color = "grey", linetype = "dashed"), # Horizontal grid lines
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_blank(), # Remove vertical grid lines
    panel.grid.minor.y = element_blank()#,
    #plot.margin = unit(c(0.5, 1, 1, 1), "cm") # Adjusted top margin for space from main plot
  )

# 5. Combine the two plots
# Use plot_grid to arrange the two plots vertically
plot_grid(p_main, p_residual, ncol = 1, rel_heights = c(0.7, 0.3), align = "v")

ggsave("hispanic_votes_chart.png", width = 10, height = 6, dpi = 300)
```

# Analysis of 2020 Pew Data

```{r}
# Use the Pew 2020 Data
# Calculate the 'Total Change' for Traditional and RCV based on components
data_components_2020 <- rcv_pew_16v20 %>%
  rename(Composition = Mix,
         Residual = Var_to_Act,
         Demographic = Race) %>%
  rowwise() %>%
  mutate(Calculated_Total = sum(Rate, Composition, Volume)) %>%
  ungroup() %>%
  mutate(Demographic = str_to_sentence(Demographic))
  

# Calculate total components across all demographics for Traditional and RCV
total_components_2020 <- data_components_2020 %>%
  summarise(
    Rate = sum(Rate),
    Composition = sum(Composition),
    Volume = sum(Volume),
    #Residual = sum(Residual)
  ) %>%
  mutate(Demographic = "Total") %>%
  ungroup()

# Bind this to the original data_components
data_components_with_total_2020 <- bind_rows(data_components_2020, total_components_2020)

# Reshape the components data for stacking
data_long_2020 <- data_components_with_total_2020 %>% 
  pivot_longer(
    cols = c(Rate, Composition, Volume),
    names_to = "Component",
    values_to = "Value"
  ) %>%
  # Add a 'Type' column to distinguish between 'Component'
  mutate(Type = "Component")

# Combine the data - only using the 'data_long' for components
final_data_2020 <- data_long_2020 %>%
  # Order the Component for stacking (bottom to top)
  mutate(Component = factor(Component,
                            levels = c("Volume", "Composition", "Rate"))) %>%
  # Order the Demographic groups, including "Total" at the end
  mutate(Demographic = factor(Demographic,
                              levels = c("Black", "Hispanic", "Asian", "White", "Other", "Total")))
```

```{r}
# Create the new stacked bar chart without facets
ggplot(final_data_2020, aes(x = Demographic, y = Value, fill = Component)) +
  geom_bar(stat = "identity", position = "stack", width = 0.7) +
  scale_fill_manual(
    values = c(
      "Rate" = colors[2],        # blue
      "Composition" = colors[3], # green
      "Volume" = colors[4]    # orange
    ),
    breaks = c("Rate", "Composition", "Volume", "Residual") # Ensure order in legend
  ) +
  labs(
    title = "RCVD Vote Change Decomposition (2016 to 2020)",
    subtitle = "Components of Change by Demographic Group",
    x = "Demographic Group",
    y = "Vote Change"
  ) +
  scale_y_continuous(labels = scales::comma) + # Format y-axis labels with commas
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10), # Rotated 45 degrees, right-justified
    axis.text.y = element_text(size = 10),
    axis.title.y = element_text(size = 12, margin = margin(r = 10)), # Add margin to y-axis title
    legend.position = "right",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 10),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey", linetype = "dashed"),
    panel.grid.minor.y = element_blank()
  )

# To save the plot (optional)
ggsave("rcv_stacked_bar_chart_2020.png", width = 8, height = 7, dpi = 300)
```


# Analysis of 2024 Pew Data

```{r}
# Use the Pew 2024 Data
# Calculate the 'Total Change' for Traditional and RCV based on components
data_components_2024 <- rcv_pew_20v24 %>%
  rename(Composition = Mix,
         Residual = Var_to_Act,
         Demographic = Race) %>%
  rowwise() %>%
  mutate(Calculated_Total = sum(Rate, Composition, Volume)) %>%
  ungroup() %>%
  mutate(Demographic = str_to_sentence(Demographic))
  

# Calculate total components across all demographics for Traditional and RCV
total_components_2024 <- data_components_2024 %>%
  summarise(
    Rate = sum(Rate),
    Composition = sum(Composition),
    Volume = sum(Volume),
    #Residual = sum(Residual)
  ) %>%
  mutate(Demographic = "Total") %>%
  ungroup()

# Bind this to the original data_components
data_components_with_total_2024 <- bind_rows(data_components_2024, total_components_2024)

# Reshape the components data for stacking
data_long_2024 <- data_components_with_total_2024 %>% 
  pivot_longer(
    cols = c(Rate, Composition, Volume),
    names_to = "Component",
    values_to = "Value"
  ) %>%
  # Add a 'Type' column to distinguish between 'Component'
  mutate(Type = "Component")

# Combine the data - only using the 'data_long' for components
final_data_2024 <- data_long_2024 %>%
  # Order the Component for stacking (bottom to top)
  mutate(Component = factor(Component,
                            levels = c("Volume", "Composition", "Rate"))) %>%
  # Order the Demographic groups, including "Total" at the end
  mutate(Demographic = factor(Demographic,
                              levels = c("Black", "Hispanic", "Asian", "White", "Other", "Total")))
```

```{r}
# Create the new stacked bar chart without facets
ggplot(final_data_2024, aes(x = Demographic, y = Value, fill = Component)) +
  geom_bar(stat = "identity", position = "stack", width = 0.7) +
  scale_fill_manual(
    values = c(
      "Rate" = colors[2],        # blue
      "Composition" = colors[3], # green
      "Volume" = colors[4]    # orange
    ),
    breaks = c("Rate", "Composition", "Volume", "Residual") # Ensure order in legend
  ) +
  labs(
    title = "RCVD Vote Change Decomposition (2020 to 2024)",
    subtitle = "Components of Change by Demographic Group",
    x = "Demographic Group",
    y = "Vote Change"
  ) +
  scale_y_continuous(labels = scales::comma) + # Format y-axis labels with commas
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10), # Rotated 45 degrees, right-justified
    axis.text.y = element_text(size = 10),
    axis.title.y = element_text(size = 12, margin = margin(r = 10)), # Add margin to y-axis title
    legend.position = "right",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 10),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey", linetype = "dashed"),
    panel.grid.minor.y = element_blank()
  )

# To save the plot (optional)
ggsave("rcv_stacked_bar_chart_2024.png", width = 8, height = 7, dpi = 300)
```


```{r}
# Function for a clean table
display_clean <- function(df) {
  # Format all numeric columns to be rounded and have commas
  formatted_df <- df %>%
    mutate(across(where(is.numeric), ~ comma(round(., 0))))

  # Return the formatted data frame as a kable table
  return(kable(formatted_df))
}

print(display_clean(rcv_pew_20v24))
```


# Analysis of 2024 vs 2016 Pew Data

```{r}
# Use the Pew 2024 Data
# Calculate the 'Total Change' for Traditional and RCV based on components
data_components_1624 <- rcv_pew_16v24 %>%
  rename(Composition = Mix,
         Residual = Var_to_Act,
         Demographic = Race) %>%
  rowwise() %>%
  mutate(Calculated_Total = sum(Rate, Composition, Volume)) %>%
  ungroup() %>%
  mutate(Demographic = str_to_sentence(Demographic))
  

# Calculate total components across all demographics for Traditional and RCV
total_components_1624 <- data_components_1624 %>%
  summarise(
    Rate = sum(Rate),
    Composition = sum(Composition),
    Volume = sum(Volume),
    #Residual = sum(Residual)
  ) %>%
  mutate(Demographic = "Total") %>%
  ungroup()

# Bind this to the original data_components
data_components_with_total_1624 <- bind_rows(data_components_1624, total_components_1624)

# Reshape the components data for stacking
data_long_1624 <- data_components_with_total_1624 %>% 
  pivot_longer(
    cols = c(Rate, Composition, Volume),
    names_to = "Component",
    values_to = "Value"
  ) %>%
  # Add a 'Type' column to distinguish between 'Component'
  mutate(Type = "Component")

# Combine the data - only using the 'data_long' for components
final_data_1624 <- data_long_1624 %>%
  # Order the Component for stacking (bottom to top)
  mutate(Component = factor(Component,
                            levels = c("Volume", "Composition", "Rate"))) %>%
  # Order the Demographic groups, including "Total" at the end
  mutate(Demographic = factor(Demographic,
                              levels = c("Black", "Hispanic", "Asian", "White", "Other", "Total")))
```

```{r}
# Create the new stacked bar chart without facets
ggplot(final_data_1624, aes(x = Demographic, y = Value, fill = Component)) +
  geom_bar(stat = "identity", position = "stack", width = 0.7) +
  scale_fill_manual(
    values = c(
      "Rate" = colors[2],        # blue
      "Composition" = colors[3], # green
      "Volume" = colors[4]    # orange
    ),
    breaks = c("Rate", "Composition", "Volume", "Residual") # Ensure order in legend
  ) +
  labs(
    title = "RCVD Vote Change Decomposition (2016 to 2024)",
    subtitle = "Components of Change by Demographic Group",
    x = "Demographic Group",
    y = "Vote Change"
  ) +
  scale_y_continuous(labels = scales::comma) + # Format y-axis labels with commas
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10), # Rotated 45 degrees, right-justified
    axis.text.y = element_text(size = 10),
    axis.title.y = element_text(size = 12, margin = margin(r = 10)), # Add margin to y-axis title
    legend.position = "right",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 10),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "grey", linetype = "dashed"),
    panel.grid.minor.y = element_blank()
  )

# To save the plot (optional)
ggsave("rcv_stacked_bar_chart_1624.png", width = 8, height = 7, dpi = 300)
```
